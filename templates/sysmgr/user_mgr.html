{% extends "base/base.html" %}
{% block title %}
YiCloud
{% endblock %}

{% block content %}
<div class="list-op" id="list_op">  
    <button type="button" class="btn btn-info btn-sm" data-toggle="modal"  id='create_user' data-target=".new-user-modal">  
        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>新建用户  
    </button>   
    <button type="button" class="btn btn-warning btn-sm" data-toggle="modal" data-target=".del-user-modal" id='DelUser'>  
        <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>批量删除用户 
    </button>  
</div> 

<!-- add user --> 
<div class="modal fade new-user-modal" tabindex="-1" role="dialog">
  	<div class="modal-dialog modal-lg">
	    <div class="modal-content">
	      	<div class="modal-header">
		        <button type="button" class="close" data-dismiss="modal"></button>
		        <h4 class="modal-title">新建用户</h4>        
	      	</div>
		    <div class="modal-body">	        
		        	<div class="input-group col-lg-4">
					    <span class="input-group-addon" >用户名称</span>
					  	<input id="user_name" type="text" class="form-control" placeholder="用户名称"   style="ime-mode:disabled"/>
					</div>				
					<div class="input-group col-lg-4">
						<span class="input-group-addon" >用户密码</span>
					  	<input id="password" type="password" class="form-control" placeholder="用户密码"  style="ime-mode:disabled"/>
					</div>
					<div class="input-group col-lg-4">
						<span class="input-group-addon" >主目录</span>
					  	<input id="user_home" type="text" class="form-control" placeholder="主目录"  style="ime-mode:disabled"/>
					</div>
					<div class="input-group col-lg-4">
						<span class="input-group-addon" >主要组</span>
					  	<input id="user_group" type="text" class="form-control" placeholder="主要组"  style="ime-mode:disabled"/>
					</div>
					<div class="input-group col-lg-4">
						<span class="input-group-addon" >附加组</span>
					  	<input id="other_group" type="text" class="form-control" placeholder="附加组,默认为空"  style="ime-mode:disabled"/>
					</div>
					<div class="input-group col-lg-4">
						<span class="input-group-addon" >用户类型</span>
					  	<input id="user_type" type="text" class="form-control" placeholder="用户类型"/>
					</div>
					<div class="input-group col-lg-4">
						<span class="input-group-addon" >邮件</span>
					  	<input id="user_mail" type="text" class="form-control" placeholder="邮件"  style="ime-mode:disabled"/>
					</div>
					<div class="input-group col-lg-4">
						<span class="input-group-addon" >电话</span>
					  	<input id="user_tel" type="text" class="form-control" placeholder="电话"  style="ime-mode:disabled"/>
					</div>
					<div class="input-group col-lg-4">
						<span class="input-group-addon" >描述</span>
					  	<input id="user_comment" type="text" class="form-control" placeholder="描述">
					</div>
					<div class="input-group col-lg-4 control-label">
					    <span class="input-group-addon">能否登录</span>
				        <select class="form-control" id="is_login">
							<option>True</option>
							<option>False</option>  
					    </select>
					</div>					  
		    </div>
		    <div class="modal-footer">
		        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
		        <button type="button" class="btn btn-primary"  id='create_confirm'>提交</button>
		    </div>
	    </div>
  	</div>
</div>	

<!-- delete user -->
<div class="modal fade del-user-modal" tabindex="-1" role="dialog">
  	<div class="modal-dialog modal-lg">
	    <div class="modal-content">
	      	<div class="modal-header">
		        <h4 class="modal-title" >删除用户</h4>        
	      	</div>
		    <div class="modal-body">	        
		        	<p id='del_msg'>
						确认删除选中用户？
					</p>				
		    </div>
		    <div class="modal-footer">
		        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
		        <button type="button" class="btn btn-primary" data-dismiss="modal" id='del_comfirm'>提交</button>
		    </div>
	    </div>
  	</div>
</div>	

<!-- modify user -->
<div class="modal fade modify-user-modal" tabindex="-1" role="dialog">
  	<div class="modal-dialog modal-lg">
	    <div class="modal-content">
	      	<div class="modal-header">
		        <h4 class="modal-title">修改用户</h4>        
	      	</div>
	    	<div class="modal-body">       
	        	<div class="input-group col-lg-4">
					    <span class="input-group-addon" >用户名称</span>
					  	<input id="modify_user_name" type="text" class="form-control"  style="ime-mode:disabled;"/>
				</div>				
				<div class="input-group col-lg-4">
						<span class="input-group-addon" >用户密码</span>
					  	<input id="modify_user_pass" type="password" class="form-control"  style="ime-mode:disabled;" />
				</div>
				<div class="input-group col-lg-4">
					    <span class="input-group-addon" >主目录</span>
					  	<input id="modify_user_home" type="text" class="form-control"  style="ime-mode:disabled;"/>
				</div>
				<div class="input-group col-lg-4">
						<span class="input-group-addon" >主要组</span>
					  	<input id="modify_user_group" type="text" class="form-control" placeholder="主要组"  style="ime-mode:disabled"/>
					</div>
					<div class="input-group col-lg-4">
						<span class="input-group-addon" >附加组</span>
					  	<input id="modify_other_group" type="text" class="form-control" placeholder="附加组"  style="ime-mode:disabled"/>
					</div>
					<div class="input-group col-lg-4">
						<span class="input-group-addon" >用户类型</span>
					  	<input id="modify_user_type" type="text" class="form-control" placeholder="用户类型" />
					</div>
					<div class="input-group col-lg-4">
						<span class="input-group-addon" >邮件</span>
					  	<input id="modify_user_mail" type="text" class="form-control" placeholder="邮件"  style="ime-mode:disabled"/>
					</div>
					<div class="input-group col-lg-4">
						<span class="input-group-addon" >电话</span>
					  	<input id="modify_user_tel" type="text" class="form-control" placeholder="电话"  style="ime-mode:disabled"/>
					</div>
					<div class="input-group col-lg-4">
						<span class="input-group-addon" >描述</span>
					  	<input id="modify_user_comment" type="text" class="form-control" placeholder="描述"/>
					</div>
					<div class="input-group col-lg-4 control-label">
					    <span class="input-group-addon">能否登录</span>
				        <select class="form-control" id="modify_is_login">
							<option>True</option>
							<option>False</option>  
					    </select>
					</div>	
			</div>	 				    
		    <div class="modal-footer">
		        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
		        <button type="button" class="btn btn-primary"  data-dismiss="modal" id='modify_confirm'>提交</button>
		    </div>
	    </div>
  	</div>
</div>	

<!-- show user info -->
<div class="panel panel-primary" id='user_info' style="margin-top: 2px;margin-right: 5px;">
	<table class="table table-hover"  style="table-layout: fixed;WORD-BREAK: break-all; WORD-WRAP: break-word">
      	<thead>
          	<tr>
          		<th>用户名称</th>
          		<th width=220>用户主目录</th>
          		<th>用户组</th>
          		<th>附加组</th>
          		<th>用户类型</th>
          		<th>邮件</th>
          		<th>电话</th>
          		<th>描述</th>
          		<th>能否登录</th>
          		<th>操作</th>
          	</tr>
		</thead>
      	<tbody id="reload" class='false'>
			{% for i in user_data %}
				<tr>
					<th class='user_name'>{{ i.user_name }}</th>
					<th class='user_home'>{{ i.user_home }}</th>
					<th class='user_group'>{{ i.user_group }}</th>
					<th class='other_group'>{{ i.other_group }}</th>
					<th class='user_type'>{{ i.user_type }}</th>
					<th class='user_mail'>{{ i.user_mail }}</th>
					<th class='user_tel'>{{ i.user_tel }}</th>
					<th class='user_comment'>{{ i.user_comment }}</th>
					<th class='is_login'>{{ i.is_login }}</th>
					<th><a href='javascript:void(0);' class="modify glyphicon glyphicon-pencil" 
							data-toggle="modal" data-target=".modify-user-modal" style='margin-top:-2px;' 
							data-toggle="tooltip" title="修改"></a>
					</th>
				</tr>						
			{% endfor %}	          			
		</tbody>
	</table>
	<ul class='pagination'>
		{% for page_num in all_page_count %}
			<li><a href='javascript:void(0);' id="/sysmgr/user_mgr/{{ page_num|add:'1' }}">{{ page_num|add:'1'}}</a></li>
		{% endfor %}
	</ul>			
</div>
<!-- new_user -->
<script type="text/javascript">
	//清空浏览器记忆的用户名和密码
	$('#create_user').click(function(){
		$.ajaxSetup({
		    data: {csrfmiddlewaretoken: '{{ csrf_token }}' },
		});
		var url = "{% url 'get_session' %}"
			$.get(url, function(data){
				if(data == 'no data'){
					alert('登录超时，请重新登录');
					window.top.location.href = '/login';
					return
				};
			});
		 $('#user_name').val('');
		 $('#password').val('')
		 $('#user_type').val('普通用户');
		 $('#user_type').attr('disabled','true');
	});
	//点击提交之后，发送数据给后台
	$('#create_confirm').click(function() {
		$.ajaxSetup({
		    data: {csrfmiddlewaretoken: '{{ csrf_token }}' },
		});
		var url = "{% url 'get_session' %}"
			$.get(url, function(data){
				if(data == 'no data'){
					alert('登录超时，请重新登录');
					window.top.location.href = '/login';
					return
				};
			});
		var user_name = $('#user_name').val();
		var user_home = $('#user_home').val();
		var user_group = $('#user_group').val();
		var other_group = $('#other_group').val();
		var user_type = $('#user_type').val();
		var user_mail = $('#user_mail').val();
		var user_tel = $('#user_tel').val();
		var user_comment = $('#user_comment').val();
		var is_login = $('#is_login').val();
		var password = $('#password').val();
		if(!user_name){
			alert('用户名不能为空');
			return
		};
		if(!password){
			alert('密码不能为空');
			return
		};
		if(!user_home){
			alert('主目录不能为空');
			return
		};
		$(this).attr('data-dismiss','modal');
		$.ajax({
			type:"post",
			url:"{% url 'create_user' %}",
			data:{user_name:user_name,password:password,user_home:user_home,user_group:user_group,
				  other_group:other_group,user_type:user_type,user_tel:user_tel,user_mail:user_mail,
				  user_comment:user_comment,is_login:is_login},
			//async:true,
			success:function(arg){
			},
			error:function(arg){
				alert('Your User is failed add!');
			}
		});
	});
	function user_refresh(){
		var url = "{% url 'sysmgr.views.user_mgr' user_mgr %}";
		$("#content").load(url)
	}
	$('.new-user-modal').on('hidden.bs.modal',function(){
		user_refresh();
	});
	$('.pagination a').click(function(){
		var url = $(this).attr('id');
    	$("#content").load(url)
	});
</script>

<!-- delete user -->
<script type="text/javascript">
	$('#DelUser').click(function(){
		$.ajaxSetup({
		    data: {csrfmiddlewaretoken: '{{ csrf_token }}' },
		});
		var url = "{% url 'get_session' %}"
			$.get(url, function(data){
				if(data == 'no data'){
					alert('登录超时，请重新登录');
					window.top.location.href = '/login';
					return
				};
			});
		var $thr = $('table tbody').find('tr');
		var user_name = new Array();
		var num = 0;
		//循环列表，查找选中的行
		$thr.each(function(){
			if($(this).attr('class') == 'warning')
			{
				user_name[num] = $(this).children('td').next().text()   //获取用户名
				num = num + 1;
			}	
		});
		if (user_name.length == 0)
		{
			$('#del_msg').html('请选择需要删除的用户！');
			$('#del_comfirm').css({'display':'none'});
		};
		user_name = user_name.toString();
		$('#del_comfirm').click(function(){
			$.ajax({
				type:"post",
				url:"{% url 'del_user'%}",
				data:{user_name:user_name},
				success:function(arg){
				},
				error:function(arg){
					//alert('Your Host is failed add!');
				}
			});
		});
	});
	$('.del-user-modal').on('hidden.bs.modal',function(){
		user_refresh();
	});
</script>

<!--  change user -->
<script type="text/javascript">
	$('.modify').click(function(){
		$.ajaxSetup({
		    data: {csrfmiddlewaretoken: '{{ csrf_token }}' },
		});
		var user_name = $(this).parent().parent().find('.user_name').text();
		var user_home = $(this).parent().parent().find('.user_home').text();
		var user_group = $(this).parent().parent().find('.user_group').text();
		var other_group = $(this).parent().parent().find('.other_group').text();
		var user_type = $(this).parent().parent().find('.user_type').text();
		var user_mail = $(this).parent().parent().find('.user_mail').text();
		var user_tel = $(this).parent().parent().find('.user_tel').text();
		var user_comment = $(this).parent().parent().find('.user_comment').text();
		var is_login = $(this).parent().parent().find('.is_login').text();
		//add current content into modal
		$('#modify_user_name').val(user_name);
		$('#modify_user_home').val(user_home);
		$('#modify_user_group').val(user_group);
		$('#modify_other_group').val(other_group);
		$('#modify_user_type').val(user_type);
		$('#modify_user_mail').val(user_mail);
		$('#modify_user_tel').val(user_tel);
		$('#modify_user_comment').val(user_comment);
		$('#modify_is_login').val(is_login);
		$('#modify_user_pass').val('原始密码');
		$('#modify_user_type').attr('disabled','true');
		$('#modify_user_name').attr('disabled','true');
		$('#modify_user_home').attr('disabled','true');
		if(user_name=='superuser'){
			$('#modify_is_login').attr('disabled','true');
		};
	});	
	//commit button
	$('#modify_confirm').click(function(){
		$.ajaxSetup({
		    data: {csrfmiddlewaretoken: '{{ csrf_token }}' },
		});
		var user_name = $('#modify_user_name').val();
		var user_pass = $('#modify_user_pass').val();
		var user_home = $('#modify_user_home').val();
		var user_type = $('#modify_user_type').val();
		var user_group = $('#modify_user_group').val();
		var other_group = $('#modify_other_group').val();
		var user_mail = $('#modify_user_mail').val();
		var user_tel = $('#modify_user_tel').val();
		var user_comment = $('#modify_user_comment').val();
		var is_login = $('#modify_is_login').val();
		$.ajax({
			type:"post",
			url:"{% url 'modify_user' %}",
			data:{user_name:user_name,user_pass:user_pass,user_home:user_home,user_type:user_type,
				  user_group:user_group,other_group:other_group,user_mail:user_mail,user_tel:user_tel,
				  user_comment:user_comment,is_login:is_login},
			success:function(arg){
			},
			error:function(arg){
				alert('Your user change failed!');
			}
		});
	});
	$('.modify-user-modal').on('hidden.bs.modal',function(){
		user_refresh();
	});
	$(function(){
		  $('[data-toggle="tooltip"]').tooltip();
	});
</script>

<!-- add checkbox -->
<script type="text/javascript">
$(function(){  
    function initTableCheckbox() {  
        var $thr = $('table thead tr');  
        var $checkAllTh = $('<th><input type="checkbox" id="checkAll" name="checkAll" />全选</th>');  
        /*将全选/反选复选框添加到表头最前，即增加一列*/  
        $thr.prepend($checkAllTh);  
        /*“全选/反选”复选框*/  
        var $checkAll = $thr.find('input');  
        $checkAll.click(function(event){  
            /*将所有行的选中状态设成全选框的选中状态*/  
            $tbr.find('input').prop('checked',$(this).prop('checked'));  
            /*并调整所有选中行的CSS样式*/  
            if ($(this).prop('checked')) {  
                $tbr.find('input').parent().parent().addClass('warning');  
            } else{  
                $tbr.find('input').parent().parent().removeClass('warning');  
            }  
            /*阻止向上冒泡，以防再次触发点击操作*/  
            event.stopPropagation();  
        });  
        /*点击全选框所在单元格时也触发全选框的点击操作*/  
        $checkAllTh.click(function(){  
            $(this).find('input').click();  
        });  
        var $tbr = $('table tbody tr');  
        var $checkItemTd = $('<td><input type="checkbox" name="checkItem" /></td>');  
        /*每一行都在最前面插入一个选中复选框的单元格*/  
        $tbr.prepend($checkItemTd);  
        /*点击每一行的选中复选框时*/  
        $tbr.find('input').click(function(event){  
            /*调整选中行的CSS样式*/  
            $(this).parent().parent().toggleClass('warning');  
            /*如果已经被选中行的行数等于表格的数据行数，将全选框设为选中状态，否则设为未选中状态*/  
            $checkAll.prop('checked',$tbr.find('input:checked').length == $tbr.length ? true : false);  
            /*阻止向上冒泡，以防再次触发点击操作*/  
            event.stopPropagation();  
        });  
        /*点击每一行时也触发该行的选中操作*/  
        
        $tbr.click(function(){  
            $(this).find('input').click();  
        });  
        
    }  
    initTableCheckbox();  
});  
</script>
{% endblock %}