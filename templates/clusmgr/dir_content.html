{% extends "base/base.html" %}
{% block title %}
YiCloud
{% endblock %}
{% block  header %}
	<script src="/static/js/jquery.address-1.6.js"></script>
	<script src="/static/js/jstree.min.js"></script> 
	<script src="/static/js/clusmgr/dir_content.js"></script> 
	<style>
		.textbox{
			height : 20px;
			margin : 0;
			padding: 0 2px;
			box-sizing : content-box;
		}
	</style>
{% endblock %}
{% block content %}
		
		
		<table id="test" class="easyui-datagrid"  data-options="fit:false,width : 'auto',fitColumns : true,nowrap : true,scrollbarSize : 0, toolbar : '#mgr_file_button',pagination : true,pageSize : 20,pageList : [20, 25, 30, 35, 40],">
	      	<thead id="folder_header">
	          	<tr>
	          		<th data-options="field:'id',checkbox:true,width:100">ID</th>
		            <th data-options="field:'name',width:100">名称</th>
		            <th data-options="field:'size',width:100">大小</th>
		            <th data-options="field:'file_type',width:100">类型</th>
		            <th data-options="field:'modify_time',width:100">修改时间</th>
		            <th data-options="field:'permission',width:100">权限</th>
		            <th data-options="field:'username',width:100">所属用户</th>
		            <th data-options="field:'group',width:100">所属用户组</th>
	          	</tr>
			</thead>
	      	<tbody id="folder_content" >
				
			</tbody>
		</table>
		<div id="mgr_file_button" style="padding:5px;">
				<div>
					<a href='#' class="easyui-linkbutton" onclick="obj.addSubTab('新建作业','{% url 'create_job_index' %}')" iconCls="icon-add" plain="true">上传文件</a>
					<a href='#' class="easyui-linkbutton" onclick="get_session();" iconCls="icon-remove"  plain="true">下载文件</a>
					<a href='#' class="easyui-linkbutton" onclick="get_session();" iconCls="icon-remove" plain="true">删除文件</a>
					<a href='#' class="easyui-linkbutton" onclick="get_session();obj.job_reload();" iconCls="icon-reload" plain="true">刷新</a>
				</div>
		</div>
		<script>
		/*
		    $('#file_upload').click(function() {
		    	folder_name = $('body').attr("id");
		    	if (folder_name){
		    		$("#input-folder-2").fileinput({
			        	language: 'zh',
			            browseLabel: '选择文件...',
			            uploadUrl: '{% url "file_upload" %}',
			            uploadExtraData:{"file_data":folder_name},
			            previewFileIcon: '<i class="fa fa-file"></i>',
			            allowedPreviewTypes: null, // set to empty, null or false to disable preview for all types
			        });
			        $("#input-folder-2").on("fileuploaded", function (event, data, previewId, index) {
			                var obj = data.response;
			                console.log(obj)
			                alert(obj);
			            });
		    	}else{
		    		$('#upload_msg').html('<p>请在左侧选择需要上传的节点和目录</p>');
		    		$('#upload_msg').next().children().css('display','block');
		    		
		    	}
		    });
		*/
		    </script>
		    <!-- 
		<script type="text/javascript">
			$('#mgr_file_info iframe',window.parent.document).contents().find('#container').on('dblclick', '.jstree-anchor', function (e) {
				$.ajaxSetup({
				    data: {csrfmiddlewaretoken: '{{ csrf_token }}' },
				});
				var folder_id = $(this).parent().attr('id'); 
				$('body').attr('id',folder_id);
				//每次加载前内容清空
				$('#folder_content').html('');
				$.ajax({
					type:"post",
					url:"{% url 'get_dir_content' %}",
					data:{folder_id:folder_id},
					success:function(arg){
						if(arg == "no data"){
							alert('登录超时，请重新登录');
							window.top.location.href = '/login';
							return
						};
						try{
							var obj = jQuery.parseJSON(arg);
							$.each(obj,function(k,v){
								var folder_name = v.name
								var folder_size = v.size;
								var folder_type = v.file_type;
								var folder_modify_time = v.modify_time;
								var folder_permission = v.permission;
								var folder_username = v.username;
								var folder_group = v.group;
								if(folder_type == '文件夹'){
									var table_content =  '<tr> <td><input type="checkbox" name="checkItem" /></td>' +
									'<td class="glyphicon glyphicon-folder-close" style="display:table-cell;position:static">'+folder_name+
									'</td> + <td>'+folder_size+ ' 字节' +
									'</td> + <td>'+folder_type+
									'</td> + <td>'+folder_modify_time+
									'</td> + <td>'+folder_permission+
									'</td> + <td>'+folder_username+
									'</td> + <td>'+folder_group+
									'</td> + </tr>';
								}else{
									var table_content = '<tr> <td><input type="checkbox" name="checkItem" /></td>' + 
									'<td class="glyphicon glyphicon-file" style="display:table-cell;position:static">'+folder_name+
									'</td> + <td>'+folder_size+ ' 字节' +
									'</td> + <td>'+folder_type+
									'</td> + <td>'+folder_modify_time+
									'</td> + <td>'+folder_permission+
									'</td> + <td>'+folder_username+
									'</td> + <td>'+folder_group+
									'</td> + </tr>';
								};
									$('#folder_content').append(table_content);
								});
							}
							catch(e){
								return e;
							}
						if (!$('#folder_content').html()){
							$('#folder_content').html('目录为空');
						};
						$(function(){  
						    function initTableCheckbox() {  
						        var $thr = $('table thead tr');  
						        /*将全选/反选复选框添加到表头最前，即增加一列*/  
						        /*“全选/反选”复选框*/  
						        var $checkAll = $thr.find('input');  
						        $checkAll.click(function(event){  
						            /*将所有行的选中状态设成全选框的选中状态*/  
						            $tbr.find('input').prop('checked',$(this).prop('checked'));  
						            /*并调整所有选中行的CSS样式*/  
						            if ($(this).prop('checked')) {  
						                $tbr.find('input').parent().parent().addClass('warning');  
						            } else{  
						                $tbr.find('input').parent().parent().removeClass('warning');  
						            }  
						            /*阻止向上冒泡，以防再次触发点击操作*/  
						            event.stopPropagation();  
						        });  
						        /*点击全选框所在单元格时也触发全选框的点击操作*/  
						        $('#checkAll').click(function(){  
						            $(this).find('input').click();  
						        });  
						        var $tbr = $('table tbody tr');   
						        /*点击每一行的选中复选框时*/  
						        $tbr.find('input').click(function(event){  
						            /*调整选中行的CSS样式*/  
						            $(this).parent().parent().toggleClass('warning');  
						            /*如果已经被选中行的行数等于表格的数据行数，将全选框设为选中状态，否则设为未选中状态*/  
						            $checkAll.prop('checked',$tbr.find('input:checked').length == $tbr.length ? true : false);  
						            /*阻止向上冒泡，以防再次触发点击操作*/  
						            event.stopPropagation();  
						        });  
						        /*点击每一行时也触发该行的选中操作*/  
						        
						        $tbr.click(function(){  
						            $(this).find('input').click();  
						        });  
						        
						    }  
						    initTableCheckbox();  
						}); 
					},
					error:function(arg){
					}
				}); //ajax结束
				
		  	});
		</script>
		 -->
		<!-- 获取当前session状态函数 -->
		<script type="text/javascript">
			function get_session(){
				var url = "{% url 'get_session' %}"
					$.get(url, function(data){
						if(data == 'no data'){
							alert('登录超时，请重新登录');
							window.top.location.href = '/login';
							return
						}
					});
			};
		</script>
{% endblock %}

<!-- upload file-->
		<div class="modal fade upload-file-modal" tabindex="-1" role="dialog">
		  	<div class="modal-dialog modal-lg">
			    <div class="modal-content">
			      	<div class="modal-header">
				        <h4 class="modal-title" >上传文件</h4>        
			      	</div>
				    <div class="modal-body" id='upload_msg'>	        
    					<input id="input-folder-2" name="input-folder-2[]" class="file-loading" type="file" multiple>
    					<div id="errorBlock" class="help-block"></div>
				    </div>
				 	<div class="modal-footer">
			        	<button type="button" class="btn btn-default" data-dismiss="modal" onclick=get_session() >关闭</button>
			    	</div>
			    </div>
		  	</div>
		</div>
		